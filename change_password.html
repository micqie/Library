<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Change Password - Library Attendance Monitoring System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/index.css">
    <link rel="icon" type="image/x-icon" href="images/favicon-32x32.png">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Library Attendance Monitoring System</a>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-container" id="login-section">
        <div class="container">
            <div class="row align-items-center justify-content-center">
                <div class="col-lg-6 col-md-8">
                    <form id="changePasswordForm">
                        <div class="form-header">
                            <i class="bi bi-shield-lock-fill"></i> CHANGE PASSWORD
                        </div>

                        <div class="alert alert-info" role="alert">
                            <i class="bi bi-info-circle me-2"></i>
                            You must change your password before continuing. This is required for security purposes.
                        </div>

                        <div id="error-message" class="text-danger mb-3"></div>

                        <div id="changePasswordFields">
                            <div class="mb-3">
                                <label for="current_password" class="form-label">Current Password</label>
                                <input type="password" class="form-control" id="current_password" placeholder="Enter current password" required />
                            </div>
                            <div class="mb-3">
                                <label for="new_password" class="form-label">New Password</label>
                                <input type="password" class="form-control" id="new_password" placeholder="Enter new password (min. 8 characters)" required />
                                <small class="form-text text-muted">Password must be at least 8 characters long</small>
                            </div>
                            <div class="mb-3">
                                <label for="confirm_password" class="form-label">Confirm New Password</label>
                                <input type="password" class="form-control" id="confirm_password" placeholder="Confirm new password" required />
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 mt-3">
                            <i class="bi bi-key-fill me-2"></i>Change Password
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check if user is logged in
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const response = await axios.get('./api/check_session.php');
                if (!response.data.success) {
                    window.location.href = './index.html';
                    return;
                }
            } catch (error) {
                window.location.href = './index.html';
                return;
            }
        });

        // Handle form submission
        document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const currentPassword = document.getElementById('current_password').value;
            const newPassword = document.getElementById('new_password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            const errorMessage = document.getElementById('error-message');

            // Clear previous error
            errorMessage.textContent = '';

            // Validate passwords match
            if (newPassword !== confirmPassword) {
                errorMessage.textContent = 'New password and confirmation do not match';
                return;
            }

            // Validate password length
            if (newPassword.length < 8) {
                errorMessage.textContent = 'New password must be at least 8 characters long';
                return;
            }

            // Validate current password is different from new password
            if (currentPassword === newPassword) {
                errorMessage.textContent = 'New password must be different from current password';
                return;
            }

            try {
                const response = await axios.post('./api/change_password.php', {
                    current_password: currentPassword,
                    new_password: newPassword,
                    confirm_password: confirmPassword
                });

                if (response.data.success) {
                    await Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: 'Password changed successfully. Redirecting...',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    window.location.href = response.data.redirectUrl;
                } else {
                    errorMessage.textContent = response.data.message || 'Failed to change password';
                }
            } catch (error) {
                if (error.response && error.response.data) {
                    errorMessage.textContent = error.response.data.message || 'An error occurred';
                } else {
                    errorMessage.textContent = 'Network error. Please try again.';
                }
            }
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

